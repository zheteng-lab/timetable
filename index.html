<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Manager | Advanced Overview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .availability-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border-width: 2px; }
        .modal-overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        select[multiple] { height: 100px; padding: 8px; }
        select[multiple] option { padding: 4px 10px; border-radius: 6px; margin-bottom: 2px; font-weight: 600; cursor: pointer; }
        select[multiple] option:checked { background-color: #4f46e5 !important; color: white; }
        #toast { transform: translateY(100px); transition: transform 0.3s ease-out; }
        #toast.show { transform: translateY(0); }
        .calendar-grid { display: grid; grid-template-columns: 80px repeat(7, 1fr); }
        .calendar-cell { min-height: 75px; border-bottom: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; }
        .view-transition { transition: opacity 0.2s ease; }
        
        /* View Toggle Styles */
        .toggle-active { background-color: white; color: #4f46e5; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .toggle-inactive { background-color: transparent; color: #64748b; }

        .status-btn-active { background-color: #1e293b; color: white; border-color: #1e293b; }
        .status-btn-inactive { background-color: white; color: #94a3b8; border-color: #e2e8f0; }
        
        .type-trial { background-color: #facc15 !important; border-color: #eab308 !important; color: #713f12 !important; }
        .type-assessment { background-color: #fef08a !important; border-color: #fde047 !important; color: #854d0e !important; }
        .type-replacement { background-color: #3b82f6 !important; border-color: #2563eb !important; color: #ffffff !important; }
        .type-regular { background-color: #4f46e5 !important; border-color: #4338ca !important; color: #ffffff !important; }
        .type-off { background-color: #f1f5f9 !important; border-color: #e2e8f0 !important; color: #94a3b8 !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-20">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-200">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                </div>
                <div>
                    <h1 class="text-sm font-black tracking-tighter uppercase text-slate-700">Staff Portal</h1>
                    <p id="statusLabel" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1">
                        <span id="statusDot" class="w-2 h-2 rounded-full bg-slate-300"></span>
                        <span id="statusText">Connecting...</span>
                    </p>
                </div>
            </div>

            <div class="flex items-center bg-slate-100 p-1 rounded-xl">
                <button onclick="window.setView('list')" id="viewListBtn" class="px-4 py-1.5 text-[10px] font-black uppercase rounded-lg transition-all toggle-active">Search List</button>
                <button onclick="window.setView('calendar')" id="viewCalendarBtn" class="px-4 py-1.5 text-[10px] font-black uppercase rounded-lg transition-all toggle-inactive">Weekly View</button>
            </div>
        </div>
    </nav>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 pointer-events-none">
        <span id="toastIcon" class="text-indigo-400">●</span>
        <span id="toastMessage" class="text-xs font-black uppercase tracking-widest">Message</span>
    </div>

    <div id="confirmDialog" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="bg-white rounded-3xl p-6 w-full max-w-xs relative z-10 shadow-2xl border border-slate-100 text-center">
            <div class="w-12 h-12 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 class="text-lg font-black text-slate-800 mb-2 uppercase">Delete?</h3>
            <p class="text-slate-500 text-[10px] font-bold uppercase mb-6">Are you sure you want to delete this booking?</p>
            <div class="flex gap-2">
                <button id="confirmActionBtn" class="flex-1 py-3 bg-red-500 text-white text-[10px] font-black rounded-xl uppercase">Delete</button>
                <button onclick="window.closeConfirm()" class="flex-1 py-3 bg-slate-100 text-slate-400 text-[10px] font-black rounded-xl uppercase">Cancel</button>
            </div>
        </div>
    </div>

    <div id="bookingModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0" onclick="window.closeBookingModal()"></div>
        <div class="bg-white rounded-3xl p-6 w-full max-w-md relative z-10 shadow-2xl">
            <h2 class="text-xl font-black text-slate-800 mb-1">New Booking</h2>
            <p id="bookingSummary" class="text-slate-500 text-[10px] mb-6 uppercase font-bold"></p>
            <div class="space-y-4 mb-6">
                <input type="text" id="studentNameInput" placeholder="Student Name" class="w-full bg-slate-50 p-4 rounded-2xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none">
                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="bookingDateInput" class="bg-slate-50 p-4 rounded-2xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none">
                    <select id="bookingTypeInput" class="bg-slate-50 p-4 rounded-2xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none">
                        <option value="Trial">Trial (Yellow)</option>
                        <option value="Assessment">Assessment (Light Yellow)</option>
                        <option value="Replacement">Replacement (Blue)</option>
                        <option value="Regular">Regular (Indigo)</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="confirmBtn" onclick="window.processBooking()" class="flex-1 py-4 bg-indigo-600 text-white text-xs font-black rounded-2xl uppercase tracking-widest">Confirm</button>
                <button onclick="window.closeBookingModal()" class="px-6 py-4 bg-slate-100 text-slate-400 text-xs font-black rounded-2xl uppercase">Close</button>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4 md:p-6">
        <div class="bg-white rounded-2xl border border-slate-200 p-4 mb-6 shadow-sm">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                <div class="md:col-span-4 space-y-4">
                    <label class="text-[9px] font-black uppercase text-slate-400 mb-1 block px-1">Visibility Filter</label>
                    <div class="flex bg-slate-100 p-1 rounded-xl gap-1">
                        <button onclick="window.setStatusFilter('all')" id="btnFilterAll" class="flex-1 py-2 text-[9px] font-black uppercase rounded-lg transition-all status-btn-active">Show All</button>
                        <button onclick="window.setStatusFilter('open')" id="btnFilterOpen" class="flex-1 py-2 text-[9px] font-black uppercase rounded-lg transition-all status-btn-inactive">Open Only</button>
                        <button onclick="window.setStatusFilter('booked')" id="btnFilterBooked" class="flex-1 py-2 text-[9px] font-black uppercase rounded-lg transition-all status-btn-inactive">Booked Only</button>
                    </div>
                    <div class="relative">
                        <input type="text" id="searchInput" oninput="window.render()" placeholder="Search Student or Teacher..." class="w-full bg-slate-50 p-4 pl-12 rounded-2xl ring-1 ring-slate-200 font-bold text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        <svg class="w-5 h-5 text-slate-400 absolute left-4 top-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>

                <div class="md:col-span-4 grid grid-cols-1 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 mb-1 block px-1">Teacher</label>
                        <select id="teacherFilter" onchange="window.render()" class="w-full bg-slate-50 p-4 rounded-xl ring-1 ring-slate-200 font-bold text-sm">
                            <option value="ALL">All Teachers</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2 px-1">
                        <input type="checkbox" id="intersectionFilter" onchange="window.render()" class="w-4 h-4 rounded text-indigo-600">
                        <label for="intersectionFilter" class="text-[10px] font-black uppercase text-slate-500 cursor-pointer">Strict Intersection</label>
                    </div>
                    <div id="weekSelectorContainer" class="hidden">
                        <label class="text-[9px] font-black uppercase text-slate-400 mb-1 block px-1">Select Week</label>
                        <input type="week" id="weekPicker" onchange="window.render()" class="w-full bg-slate-50 p-4 rounded-xl ring-1 ring-slate-200 font-bold text-sm">
                    </div>
                </div>

                <div id="listFilters" class="md:col-span-4 grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 mb-1 block px-1">Days</label>
                        <select id="dayFilter" multiple onchange="window.render()" class="w-full bg-slate-50 rounded-xl ring-1 ring-slate-200 text-sm overflow-y-auto">
                            <option value="Mon">Monday</option>
                            <option value="Tue">Tuesday</option>
                            <option value="Wed">Wednesday</option>
                            <option value="Thu">Thursday</option>
                            <option value="Fri">Friday</option>
                            <option value="Sat">Saturday</option>
                            <option value="Sun">Sunday</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 mb-1 block px-1">Times</label>
                        <select id="timeFilter" multiple onchange="window.render()" class="w-full bg-slate-50 rounded-xl ring-1 ring-slate-200 text-sm overflow-y-auto"></select>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="listView" class="view-transition">
            <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </div>

        <div id="calendarView" class="hidden view-transition">
            <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                    <div>
                        <span class="text-[10px] font-black uppercase text-slate-400">Weekly Schedule</span>
                        <h4 id="calendarDateRange" class="text-xs font-bold text-slate-700"></h4>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                            <span class="text-[8px] font-black uppercase text-slate-500">Trial</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-yellow-100 border border-yellow-300"></span>
                            <span class="text-[8px] font-black uppercase text-slate-500">Asmt</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                            <span class="text-[8px] font-black uppercase text-slate-500">Replace</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-indigo-600"></span>
                            <span class="text-[8px] font-black uppercase text-slate-500">Free</span>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <div class="min-w-[1000px]">
                        <div class="calendar-grid bg-white border-b border-slate-200">
                            <div class="p-4"></div>
                            <div id="col-Mon" class="p-4 text-center">
                                <p class="text-[10px] font-black uppercase text-slate-400">Mon</p>
                                <p class="date-label text-[9px] font-bold text-slate-500"></p>
                            </div>
                            <div id="col-Tue" class="p-4 text-center">
                                <p class="text-[10px] font-black uppercase text-slate-400">Tue</p>
                                <p class="date-label text-[9px] font-bold text-slate-500"></p>
                            </div>
                            <div id="col-Wed" class="p-4 text-center">
                                <p class="text-[10px] font-black uppercase text-slate-400">Wed</p>
                                <p class="date-label text-[9px] font-bold text-slate-500"></p>
                            </div>
                            <div id="col-Thu" class="p-4 text-center">
                                <p class="text-[10px] font-black uppercase text-slate-400">Thu</p>
                                <p class="date-label text-[9px] font-bold text-slate-500"></p>
                            </div>
                            <div id="col-Fri" class="p-4 text-center">
                                <p class="text-[10px] font-black uppercase text-slate-400">Fri</p>
                                <p class="date-label text-[9px] font-bold text-slate-500"></p>
                            </div>
                            <div id="col-Sat" class="p-4 text-center">
                                <p class="text-[10px] font-black uppercase text-slate-400">Sat</p>
                                <p class="date-label text-[9px] font-bold text-slate-500"></p>
                            </div>
                            <div id="col-Sun" class="p-4 text-center">
                                <p class="text-[10px] font-black uppercase text-slate-400">Sun</p>
                                <p class="date-label text-[9px] font-bold text-slate-500"></p>
                            </div>
                        </div>
                        <div id="calendarBody"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyATmsswJCUH2kzgyqhtgSHfwAfJLWhMBK0",
          authDomain: "class-one-students-enquiry.firebaseapp.com",
          projectId: "class-one-students-enquiry",
          storageBucket: "class-one-students-enquiry.firebasestorage.app",
          messagingSenderId: "808629452867",
          appId: "1:808629452867:web:fc65ad3a56b08b258fd4f6",
          measurementId: "G-BXL181G4N0"
        };

        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx6Mm6KW5LjT3NP9mSSB_XgNlxRQKm9ecptBcdy5Ys3mnyJe5ZbxRKcTXsw9yVhjQ-2/exec";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'timetable-manager-pro-v3';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let masterData = [];
        let cloudBookings = [];
        let currentView = 'list';
        let currentUser = null;
        let statusFilter = 'all'; 

        const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const TIMES = [];
        for(let h=8; h<=21; h++){ 
            for(let m of ['00','30']){
                const ampm = h >= 12 ? 'pm' : 'am';
                const h12 = h % 12 || 12;
                TIMES.push(`${h12}:${m}${ampm}`);
            }
        }

        const init = async () => {
            const timeFilter = document.getElementById('timeFilter');
            TIMES.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t; opt.text = t;
                timeFilter.appendChild(opt);
            });

            const now = new Date();
            const year = now.getFullYear();
            const week = getWeekNumber(now);
            document.getElementById('weekPicker').value = `${year}-W${String(week).padStart(2, '0')}`;

            try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (tokenErr) {
                    console.warn("Auth mismatch, falling back to anonymous login...");
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
            }
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    setupRealtimeSync();
                    window.fetchSheetData();
                }
            });
        } catch (err) { 
            console.error("Critical Auth Error:", err);
            updateStatus("Error", "bg-red-500"); 
        }
    };
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
        }

        function setupRealtimeSync() {
            const bookingsRef = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
            onSnapshot(bookingsRef, (snap) => {
                cloudBookings = [];
                snap.forEach(doc => cloudBookings.push({ ...doc.data(), id: doc.id }));
                window.render();
            }, (err) => console.error("Firestore error:", err));
        }

        window.fetchSheetData = async function() {
            updateStatus("Syncing", "bg-indigo-400");
            try {
                const res = await fetch(SCRIPT_URL);
                masterData = await res.json();
                populateTeachers();
                updateStatus("Live", "bg-green-500");
                window.render();
            } catch (err) { updateStatus("Fail", "bg-red-500"); }
        };

        function populateTeachers() {
            const select = document.getElementById('teacherFilter');
            if (!select) return;
            const teachers = [...new Set(masterData.map(i => i.teacher))].filter(Boolean).sort();
            select.innerHTML = '<option value="ALL">All Teachers</option>';
            teachers.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t; opt.text = t; select.appendChild(opt);
            });
        }

       window.formatTime = function(t) {
        // If it's already a string (like "9:00am"), just return it
           if (typeof t === 'string') return t.toLowerCase().replace(/\s/g, '');
           return t;
        };
    
        // Fallback for Date objects
        const d = new Date(t);
        let h = d.getHours();
        let m = d.getMinutes();
        if (m < 15) m = 0; else if (m < 45) m = 30; else { m = 0; h += 1; }
        const ampm = h >= 12 ? 'pm' : 'am';
        const h12 = h % 12 || 12;
        return `${h12}:${m === 0 ? '00' : m}${ampm}`;
    };

        window.setStatusFilter = function(val) {
            statusFilter = val;
            const buttons = {
                all: document.getElementById('btnFilterAll'),
                open: document.getElementById('btnFilterOpen'),
                booked: document.getElementById('btnFilterBooked')
            };
            Object.keys(buttons).forEach(k => {
                if(buttons[k]) {
                    buttons[k].className = (k === val) 
                        ? "flex-1 py-2 text-[9px] font-black uppercase rounded-lg transition-all status-btn-active"
                        : "flex-1 py-2 text-[9px] font-black uppercase rounded-lg transition-all status-btn-inactive";
                }
            });
            window.render();
        };

        window.setView = function(v) {
            currentView = v;
            
            // Toggle Content Visibility
            document.getElementById('listView').classList.toggle('hidden', v !== 'list');
            document.getElementById('calendarView').classList.toggle('hidden', v !== 'calendar');
            
            // Toggle Navigation Button Highlighting
            const listBtn = document.getElementById('viewListBtn');
            const calBtn = document.getElementById('viewCalendarBtn');
            
            if (v === 'list') {
                listBtn.classList.replace('toggle-inactive', 'toggle-active');
                calBtn.classList.replace('toggle-active', 'toggle-inactive');
            } else {
                calBtn.classList.replace('toggle-inactive', 'toggle-active');
                listBtn.classList.replace('toggle-active', 'toggle-inactive');
            }
            
            // Filter UI adjustments
            const filters = document.getElementById('listFilters');
            if(filters) {
                filters.classList.toggle('opacity-20', v === 'calendar');
                filters.style.pointerEvents = v === 'calendar' ? 'none' : 'auto';
            }
            
            const weekCont = document.getElementById('weekSelectorContainer');
            if(weekCont) weekCont.classList.toggle('hidden', v !== 'calendar');
            
            window.render();
        };

        function getDatesForSelectedWeek() {
            const weekPicker = document.getElementById('weekPicker');
            if (!weekPicker || !weekPicker.value) return null;
            const [year, week] = weekPicker.value.split('-W');
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4) ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            
            const dates = [];
            for(let i=0; i<7; i++) {
                const d = new Date(ISOweekStart);
                d.setDate(ISOweekStart.getDate() + i);
                dates.push(d);
            }
            return dates;
        }

        window.render = function() {
            if(currentView === 'list') renderList();
            else renderCalendar();
        };

        function renderList() {
            const grid = document.getElementById('resultsGrid');
            if (!grid) return;

            const search = (document.getElementById('searchInput')?.value || '').toLowerCase();
            const filterTeacher = document.getElementById('teacherFilter')?.value || 'ALL';
            
            const intersectionEl = document.getElementById('intersectionFilter');
            const isIntersection = intersectionEl ? intersectionEl.checked : false;

            const selDays = Array.from(document.getElementById('dayFilter')?.selectedOptions || []).map(o => o.value);
            const selTimes = Array.from(document.getElementById('timeFilter')?.selectedOptions || []).map(o => o.value);

            grid.innerHTML = '';

            let allowedTeachers = null;
            if (isIntersection && (selDays.length > 0 || selTimes.length > 0)) {
                allowedTeachers = [...new Set(masterData.map(i => i.teacher))].filter(teacher => {
                    const slots = masterData.filter(m => m.teacher === teacher);
                    if (selDays.length > 0 && !selDays.every(d => slots.some(s => s.day.startsWith(d)))) return false;
                    if (selTimes.length > 0 && !selTimes.every(tv => slots.some(s => window.formatTime(s.time) === tv))) return false;
                    return true;
                });
            }

            masterData.forEach(item => {
                const displayTime = item.time;;
                const baseId = `${item.teacher}_${item.day}_${displayTime}`.replace(/[^a-z0-9]/gi, '_');
                
                if (filterTeacher !== 'ALL' && item.teacher !== filterTeacher) return;
                if (selDays.length > 0 && !selDays.some(d => item.day.startsWith(d))) return;
                if (selTimes.length > 0 && !selTimes.includes(displayTime)) return;

                const slotBookings = cloudBookings.filter(b => b.baseId === baseId);
                const matchesSearch = !search || item.teacher.toLowerCase().includes(search) || slotBookings.some(b => b.student.toLowerCase().includes(search));
                if (!matchesSearch) return;

                const isOpen = slotBookings.length === 0;
                if (statusFilter === 'open' && !isOpen) return;
                if (statusFilter === 'booked' && isOpen) return;

                if (isOpen) {
                    const card = document.createElement('div');
                    card.className = "p-5 rounded-3xl border border-slate-200 bg-white availability-card flex flex-col justify-between";
                    card.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-black text-slate-800 text-sm uppercase">${item.teacher}</h3>
                                <span class="text-[8px] font-black px-2 py-1 rounded bg-green-50 text-green-600 uppercase">Open</span>
                            </div>
                            <div class="flex gap-2 mb-4">
                                <div class="bg-slate-50 px-3 py-1.5 rounded-lg flex-1 text-center font-black text-[9px] text-slate-500">${item.day}</div>
                                <div class="bg-indigo-50 px-3 py-1.5 rounded-lg flex-1 text-center font-black text-[9px] text-indigo-600">${displayTime}</div>
                            </div>
                        </div>
                        <button onclick="window.openBookingModal('${baseId}', '${item.teacher}', '${item.day}', '${displayTime}')" class="w-full py-3 bg-slate-900 text-white text-[10px] font-black uppercase rounded-2xl hover:bg-indigo-600 transition-all">Book</button>
                    `;
                    grid.appendChild(card);
                } else {
                    slotBookings.forEach(booked => {
                        const card = document.createElement('div');
                        card.className = "p-5 rounded-3xl border border-slate-800 bg-slate-900 text-white availability-card flex flex-col justify-between";
                        card.innerHTML = `
                            <div>
                                <div class="flex justify-between items-start mb-4">
                                    <h3 class="font-black text-sm uppercase">${item.teacher}</h3>
                                    <span class="text-[8px] font-black px-2 py-1 rounded bg-indigo-600 uppercase">${booked.type}</span>
                                </div>
                                <div class="bg-slate-800 p-3 rounded-2xl border border-slate-700">
                                    <p class="text-[11px] font-black uppercase text-indigo-300 leading-tight mb-1">${booked.student}</p>
                                    <p class="text-[9px] font-black text-white/40 uppercase">${displayTime} • ${booked.date}</p>
                                </div>
                            </div>
                            <button onclick="window.requestDelete('${booked.id}')" class="mt-4 w-full py-3 bg-white/10 text-white/50 text-[10px] font-black uppercase rounded-2xl hover:bg-red-500 hover:text-white transition-all">Cancel</button>
                        `;
                        grid.appendChild(card);
                    });
                }
            });
        }

        function renderCalendar() {
            const body = document.getElementById('calendarBody');
            if (!body) return;

            const teacherFilter = document.getElementById('teacherFilter')?.value || 'ALL';
            const searchStr = (document.getElementById('searchInput')?.value || '').toLowerCase();
            const weekDates = getDatesForSelectedWeek();
            body.innerHTML = '';

            if (!weekDates) return;

            DAYS.forEach((day, idx) => {
                const short = day.substring(0, 3);
                const col = document.getElementById(`col-${short}`);
                if (col) {
                    const label = col.querySelector('.date-label');
                    if(label) label.innerText = weekDates[idx].toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            });

            const rangeLabel = `${weekDates[0].toLocaleDateString()} - ${weekDates[6].toLocaleDateString()}`;
            const rangeLabelEl = document.getElementById('calendarDateRange');
            if(rangeLabelEl) rangeLabelEl.innerText = rangeLabel;

            TIMES.forEach(time => {
                const row = document.createElement('div');
                row.className = "calendar-grid";
                
                const timeCell = document.createElement('div');
                timeCell.className = "calendar-cell p-2 flex items-center justify-center bg-slate-50";
                timeCell.innerHTML = `<span class="text-[9px] font-black text-slate-400 uppercase">${time}</span>`;
                row.appendChild(timeCell);

                weekDates.forEach((date, idx) => {
                    const dayCell = document.createElement('div');
                    dayCell.className = "calendar-cell p-1 flex flex-col gap-1 overflow-hidden";
                    
                    const dayShort = DAYS[idx].substring(0, 3);
                    const isoDate = date.toISOString().split('T')[0];
                    
                    let cellBookings = cloudBookings.filter(b => b.date === isoDate && b.time === time);
                    if (teacherFilter !== 'ALL') cellBookings = cellBookings.filter(b => b.teacher === teacherFilter);
                    if (searchStr) cellBookings = cellBookings.filter(b => b.student.toLowerCase().includes(searchStr) || b.teacher.toLowerCase().includes(searchStr));

                    if (statusFilter !== 'open') {
                        cellBookings.forEach(b => {
                            const div = document.createElement('div');
                            let typeClass = 'type-regular';
                            let displayContent = `<span>${b.teacher}</span> <br/> <span class="opacity-80">${b.student}</span>`;
                            
                            if (b.type === 'Trial') typeClass = 'type-trial';
                            else if (b.type === 'Assessment') typeClass = 'type-assessment';
                            else if (b.type === 'Replacement') typeClass = 'type-replacement';
                            else if (b.type === 'Regular') {
                                typeClass = 'type-off';
                                displayContent = `<span class="text-[10px] opacity-40">OFF</span>`;
                            }

                            div.className = `p-1.5 rounded-lg text-[8px] font-black uppercase truncate border ${typeClass} cursor-pointer hover:scale-[1.02] transition-transform shadow-sm`;
                            div.innerHTML = displayContent;
                            div.onclick = () => window.requestDelete(b.id);
                            dayCell.appendChild(div);
                        });
                    }

                    if (statusFilter !== 'booked' && cellBookings.length === 0) {
                         const hasMasterSlot = masterData.some(m => m.day.startsWith(dayShort) && window.formatTime(m.time) === time && (teacherFilter === 'ALL' || m.teacher === teacherFilter));
                         if (hasMasterSlot) {
                             const btn = document.createElement('div');
                             btn.className = "h-4 w-full border border-dashed border-slate-200 rounded flex items-center justify-center opacity-40 hover:opacity-100 transition-opacity cursor-pointer";
                             btn.innerHTML = `<span class="text-[7px] text-slate-300">+</span>`;
                             btn.onclick = () => {
                                 const m = masterData.find(m => m.day.startsWith(dayShort) && window.formatTime(m.time) === time && (teacherFilter === 'ALL' || m.teacher === teacherFilter));
                                 const baseId = `${m.teacher}_${m.day}_${time}`.replace(/[^a-z0-9]/gi, '_');
                                 activeSlot = { baseId, teacher: m.teacher, day: DAYS[idx], time };
                                 const summaryEl = document.getElementById('bookingSummary');
                                 if(summaryEl) summaryEl.innerText = `${m.teacher} | ${DAYS[idx]} | ${time}`;
                                 document.getElementById('bookingModal')?.classList.remove('hidden');
                                 const dateInput = document.getElementById('bookingDateInput');
                                 if(dateInput) dateInput.value = isoDate;
                             };
                             dayCell.appendChild(btn);
                         }
                    }

                    row.appendChild(dayCell);
                });
                body.appendChild(row);
            });
        }

        let activeSlot = null;
        window.openBookingModal = function(baseId, teacher, day, time) {
            activeSlot = { baseId, teacher, day, time };
            const summaryEl = document.getElementById('bookingSummary');
            if(summaryEl) summaryEl.innerText = `${teacher} | ${day} | ${time}`;
            document.getElementById('bookingModal')?.classList.remove('hidden');
            const dateInput = document.getElementById('bookingDateInput');
            if(dateInput) dateInput.value = new Date().toISOString().split('T')[0];
        };

        window.closeBookingModal = () => document.getElementById('bookingModal')?.classList.add('hidden');

        window.processBooking = async function() {
            const student = document.getElementById('studentNameInput')?.value.trim();
            const date = document.getElementById('bookingDateInput')?.value;
            const type = document.getElementById('bookingTypeInput')?.value;
            if(!student) return showToast("Enter Name", "bg-red-500");
            const btn = document.getElementById('confirmBtn');
            if(btn) btn.disabled = true;
            try {
                const docId = `bk_${Date.now()}`;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', docId), {
                    baseId: activeSlot.baseId, student, date, type,
                    teacher: activeSlot.teacher, day: activeSlot.day, time: activeSlot.time,
                    uid: currentUser?.uid || 'anon'
                });
                window.closeBookingModal();
                showToast("Booking Successful!", "bg-indigo-600");
            } catch (err) { 
                showToast("Save Error", "bg-red-600"); 
            }
            finally { if(btn) btn.disabled = false; }
        };

        let pendingDeleteId = null;
        window.requestDelete = function(id) {
            pendingDeleteId = id;
            document.getElementById('confirmDialog')?.classList.remove('hidden');
            const confirmBtn = document.getElementById('confirmActionBtn');
            if(confirmBtn) confirmBtn.onclick = window.executeDelete;
        };

        window.closeConfirm = () => document.getElementById('confirmDialog')?.classList.add('hidden');

        window.executeDelete = async function() {
            if(!pendingDeleteId) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', pendingDeleteId));
                showToast("Booking Cancelled", "bg-red-500");
            } catch (err) { showToast("Error cancelling", "bg-red-600"); }
            finally { window.closeConfirm(); }
        };

        function showToast(msg, color) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMessage');
            if(toastMsg) toastMsg.innerText = msg;
            if(toast) {
                toast.className = `fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] ${color} text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 show`;
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        }

        function updateStatus(text, color) {
            const l = document.getElementById('statusText');
            const d = document.getElementById('statusDot');
            if(l) l.innerText = text; if(d) d.className = `w-2 h-2 rounded-full ${color}`;
        }

        init();
    </script>
</body>
</html>
