<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class One Scheduler - Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .slot-cell { transition: all 0.1s; cursor: pointer; border: 1px solid #f1f5f9; font-size: 10px; font-weight: bold; text-align: center; height: 40px; min-width: 80px; }
        .slot-free { background-color: #f0fdf4; border-color: #bbf7d0; color: #166534; }
        .slot-booked { background-color: #fef2f2; border-color: #fecaca; color: #991b1b; }
        .slot-off { background-color: #f8fafc; border-color: #e2e8f0; color: #94a3b8; }
        .sidebar-active { background-color: #4f46e5; color: white; border-color: #4338ca; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Loading animation for data sync */
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .syncing { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <!-- LOADING OVERLAY -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center transition-opacity duration-500">
        <div class="text-center p-6">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <h2 class="text-base font-bold text-slate-800 mb-1">Connecting to Master Database</h2>
            <p class="text-slate-400 text-xs">Linking Google Sheets & Firebase...</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 lg:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Class One <span class="text-indigo-600">Scheduler</span></h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Live Integration Active</p>
            </div>
            <div class="flex bg-white p-1 rounded-xl shadow-sm border border-slate-200">
                <button id="viewBtn" class="px-6 py-2 text-sm font-bold rounded-lg bg-indigo-600 text-white shadow-md transition-all">Sales View</button>
                <button id="editBtn" class="px-6 py-2 text-sm font-bold rounded-lg text-slate-500 hover:bg-slate-50 transition-colors">Admin Update</button>
            </div>
        </header>

        <!-- DASHBOARD SECTION (Sales) -->
        <div id="dashboardSection" class="space-y-4">
            <div class="bg-white p-5 rounded-2xl border border-slate-200 grid grid-cols-1 md:grid-cols-4 gap-4 shadow-sm">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Check Availability For</label>
                    <input type="date" id="dashDate" class="w-full bg-slate-50 p-2.5 rounded-xl border-none text-sm outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Filter Subject</label>
                    <select id="filterSubject" class="w-full bg-slate-50 p-2.5 rounded-xl border-none text-sm outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500">
                        <option value="All">All Subjects</option>
                        <option>BC</option><option>BM</option><option>BI</option><option>PK</option><option>SOK</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Filter Day</label>
                    <select id="filterDay" class="w-full bg-slate-50 p-2.5 rounded-xl border-none text-sm outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500">
                        <option value="All">All Days</option>
                        <option>Mon</option><option>Tue</option><option>Wed</option><option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
                    </select>
                </div>
                <div class="flex flex-col items-end justify-center">
                    <div id="sheetStatus" class="px-3 py-1 rounded-full bg-slate-100 border border-slate-200 text-[9px] font-black text-slate-500 flex items-center gap-2">
                         Connecting Sheets...
                    </div>
                    <div id="dbStatus" class="mt-1 text-[8px] font-bold text-slate-400 uppercase">Database: Synchronizing</div>
                </div>
            </div>
            
            <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                <!-- Data populated via JS -->
            </div>
        </div>

        <!-- EDITOR SECTION (Admin) -->
        <div id="editorSection" class="hidden flex flex-col md:flex-row gap-6">
            <div class="w-full md:w-72 space-y-1 max-h-[75vh] overflow-y-auto pr-2 scrollbar-hide" id="teacherSidebar"></div>
            
            <div class="flex-1 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex flex-col sm:flex-row justify-between gap-4">
                    <div>
                        <h2 id="currentTeacherTitle" class="font-bold text-lg text-slate-800 uppercase">Select Teacher</h2>
                        <div id="teacherDetailsDisplay" class="text-[10px] font-bold text-indigo-600 uppercase"></div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-4 bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex flex-col">
                            <label class="text-[9px] font-bold text-slate-400 uppercase mb-1">Start Date</label>
                            <input type="date" id="startDate" class="text-xs p-1.5 rounded border border-slate-200">
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[9px] font-bold text-slate-400 uppercase mb-1">End Date</label>
                            <input type="date" id="endDate" class="text-xs p-1.5 rounded border border-slate-200">
                        </div>
                        <div class="flex items-center self-end">
                            <div id="syncIndicator" class="text-[9px] font-black text-slate-400 px-3 py-2 rounded-lg bg-slate-50 border border-slate-100 uppercase">Local Cache Only</div>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead class="bg-slate-50/80">
                            <tr id="tableHeader"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // INTEGRATED GOOGLE SCRIPT URL
        // ==========================================
        const GOOGLE_SHEET_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyk-ncHlPyw-eIyYy2E4UCHC1uLr_tM73Q0ml2TlGjyHi77NxVlMk-waGv64D_nPD3z/exec";

        const firebaseConfig = {
            apiKey: "AIzaSyATmsswJCUH2kzgyqhtgSHfwAfJLWhMBK0",
            authDomain: "class-one-students-enquiry.firebaseapp.com",
            projectId: "class-one-students-enquiry",
            storageBucket: "class-one-students-enquiry.firebasestorage.app",
            messagingSenderId: "808629452867",
            appId: "1:808629452867:web:fc65ad3a56b08b258fd4f6"
        };

        const appId = "timetable-manager-v4-range";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const teacherMetadata = [
            { name: "Peggy Lok", subjects: ["BC"], assessment: true },
            { name: "Chei Leng", subjects: ["BC"], assessment: false },
            { name: "Adelynshia", subjects: ["BM", "PK"], assessment: true },
            { name: "Aubrey", subjects: ["SOK"], assessment: false },
            { name: "Avy Lau Hui Chwin", subjects: ["BM", "PK"], assessment: false },
            { name: "Nur Zahraa Balqis", subjects: ["BM", "PK"], assessment: false },
            { name: "Catherine Mu", subjects: ["BC"], assessment: false },
            { name: "Cher Xi", subjects: ["BC"], assessment: false },
            { name: "Ho Ling Yi", subjects: ["PK"], assessment: false },
            { name: "Ho Yu Xun", subjects: ["BC"], assessment: false },
            { name: "Hoh Kar Yee", subjects: ["BM"], assessment: false },
            { name: "Jenna Choong Lee Hung", subjects: ["BC", "BM"], assessment: false },
            { name: "Joy Chai Yi Ling", subjects: ["BC"], assessment: false },
            { name: "Karen Lee Wai Leng", subjects: ["BC"], assessment: true },
            { name: "Kelly Chong Kah Yee", subjects: ["BM", "PK"], assessment: false },
            { name: "Lee Shok Yuong", subjects: ["BC"], assessment: false },
            { name: "Lee Pek Kian", subjects: ["BI"], assessment: false },
            { name: "Lim Mei King", subjects: ["BI"], assessment: false },
            { name: "Lim Tze Wei (Candy)", subjects: ["BC"], assessment: false },
            { name: "Loo Eling", subjects: ["BC"], assessment: false },
            { name: "Manjusri Sivakumar", subjects: ["BI", "SOK"], assessment: false },
            { name: "Ooi Ming Yi", subjects: ["BI", "SOK"], assessment: false },
            { name: "Sam", subjects: ["SOK"], assessment: false },
            { name: "Sherrenii", subjects: ["BI", "SOK"], assessment: false },
            { name: "Shirley Lim Shay Li", subjects: ["BC", "BI"], assessment: true },
            { name: "Su Poh Yi", subjects: ["BC"], assessment: false },
            { name: "Susan Siew", subjects: ["BC", "BM", "PK"], assessment: false },
            { name: "Tan Jing En", subjects: ["BM"], assessment: false },
            { name: "Tan Jing Ru", subjects: ["BM"], assessment: false },
            { name: "Tan Tze Ting", subjects: ["BM", "PK"], assessment: true },
            { name: "Teh Dick Way", subjects: ["SOK"], assessment: false },
            { name: "Wendy Chee", subjects: ["BC"], assessment: false },
            { name: "Wong Kai Ling", subjects: ["BC"], assessment: true }
        ];
        
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const times = [];
        for (let h = 8; h <= 21; h++) {
            const p = h >= 12 ? 'PM' : 'AM';
            const hr = h > 12 ? h - 12 : h === 0 ? 12 : h;
            times.push(`${hr}:00 ${p}`, `${hr}:30 ${p}`);
        }

        let allSchedules = []; 
        let currentRangeData = { schedule: {} };
        let activeTeacherName = teacherMetadata[0].name;

        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('dashDate').value = todayStr;
        document.getElementById('startDate').value = todayStr;
        const nextWeek = new Date(); nextWeek.setDate(nextWeek.getDate() + 7);
        document.getElementById('endDate').value = nextWeek.toISOString().split('T')[0];

        async function init() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById('dbStatus').innerText = "Firebase: Online";
                    setupListeners();
                } else {
                    signInAnonymously(auth);
                }
            });
        }

        function setupListeners() {
            // Real-time listener for all schedule ranges stored in Firebase
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'ranges');
            onSnapshot(colRef, (snap) => {
                allSchedules = [];
                snap.forEach(doc => allSchedules.push({ id: doc.id, ...doc.data() }));
                document.getElementById('loading').classList.add('hidden');
                renderSidebar();
                renderDashboard();
            }, (err) => {
                document.getElementById('dbStatus').innerText = "Firebase Error";
            });

            document.getElementById('dashDate').onchange = renderDashboard;
            document.getElementById('filterSubject').onchange = renderDashboard;
            document.getElementById('filterDay').onchange = renderDashboard;
            document.getElementById('startDate').onchange = fetchRangeData;
            document.getElementById('endDate').onchange = fetchRangeData;
            
            fetchRangeData();
            pingSheets();
        }

        async function pingSheets() {
            const el = document.getElementById('sheetStatus');
            try {
                // Testing connection to your specific Google Script URL
                const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, { 
                    method: 'GET',
                    mode: 'no-cors' 
                });
                el.innerText = "SHEETS CONNECTED";
                el.className = "px-3 py-1 rounded-full bg-green-50 border border-green-100 text-[9px] font-black text-green-600 flex items-center gap-2";
            } catch (e) {
                el.innerText = "SHEETS TIMEOUT";
                el.className = "px-3 py-1 rounded-full bg-amber-50 border border-amber-100 text-[9px] font-black text-amber-600 flex items-center gap-2";
            }
        }

        async function fetchRangeData() {
            if (!auth.currentUser) return;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const docId = `${activeTeacherName}_${start}_${end}`.replace(/[^a-zA-Z0-9]/g, '_');
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'ranges', docId);
            
            const indicator = document.getElementById('syncIndicator');
            indicator.innerText = "FETCHING...";
            
            try {
                const res = await getDoc(docRef);
                currentRangeData = res.exists() ? res.data() : { 
                    teacher: activeTeacherName, 
                    start, 
                    end, 
                    schedule: {} 
                };
                indicator.innerText = "READY";
                renderEditor();
            } catch (e) {
                indicator.innerText = "OFFLINE";
            }
        }

        window.toggleSlot = async (day, time) => {
            const key = `${day}-${time}`;
            const states = ['OFF', 'FREE', 'BOOKED'];
            const current = currentRangeData.schedule[key] || 'OFF';
            const next = states[(states.indexOf(current) + 1) % states.length];
            
            currentRangeData.schedule[key] = next;
            const el = document.getElementById(`cell-${day}-${time}`);
            if(el) {
                el.className = `slot-cell slot-${next.toLowerCase()}`;
                el.innerText = next;
            }

            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const docId = `${activeTeacherName}_${start}_${end}`.replace(/[^a-zA-Z0-9]/g, '_');
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'ranges', docId);
            
            document.getElementById('syncIndicator').innerText = "SAVING...";
            try {
                await setDoc(docRef, currentRangeData);
                document.getElementById('syncIndicator').innerText = "SAVED TO CLOUD";
                
                // OPTIONAL: Also push to Google Sheets here if your script supports POST
                pushToSheets(currentRangeData);
            } catch(e) {
                document.getElementById('syncIndicator').innerText = "SAVE FAILED";
            }
        };

        async function pushToSheets(data) {
            // This is a background task to keep Sheets updated
            try {
                fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(data)
                });
            } catch(e) {
                console.warn("Sheets push failed - ignoring background error");
            }
        }

        function renderEditor() {
            const meta = teacherMetadata.find(t => t.name === activeTeacherName);
            document.getElementById('currentTeacherTitle').innerText = activeTeacherName;
            document.getElementById('teacherDetailsDisplay').innerText = 
                `${meta.subjects.join(' & ')} ${meta.assessment ? 'â€¢ ASSESSMENT' : ''}`;

            const head = document.getElementById('tableHeader');
            head.innerHTML = '<th class="p-2 text-[10px] text-slate-400 border-b">Time</th>' + 
                days.map(d => `<th class="p-2 text-[10px] text-slate-400 border-b">${d}</th>`).join('');
            
            const body = document.getElementById('tableBody');
            body.innerHTML = times.map(t => `
                <tr class="hover:bg-slate-50/50">
                    <td class="p-2 text-[9px] font-bold text-slate-400 bg-slate-50/30 border-b">${t}</td>
                    ${days.map(d => {
                        const status = currentRangeData.schedule[`${d}-${t}`] || 'OFF';
                        return `<td id="cell-${d}-${t}" onclick="toggleSlot('${d}', '${t}')" class="slot-cell slot-${status.toLowerCase()}">${status}</td>`;
                    }).join('')}
                </tr>
            `).join('');
        }

        window.renderDashboard = () => {
            const checkDateVal = document.getElementById('dashDate').value;
            const checkDate = new Date(checkDateVal);
            const dayIdx = (checkDate.getDay() + 6) % 7;
            const checkDay = days[dayIdx];
            
            const subFilter = document.getElementById('filterSubject').value;
            const dayFilter = document.getElementById('filterDay').value;
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';
            let count = 0;

            allSchedules.forEach(record => {
                if (checkDateVal >= record.start && checkDateVal <= record.end) {
                    const meta = teacherMetadata.find(t => t.name === record.teacher);
                    if (!meta) return;
                    if (subFilter !== 'All' && !meta.subjects.includes(subFilter)) return;
                    if (dayFilter !== 'All' && checkDay !== dayFilter) return;

                    times.forEach(t => {
                        if (record.schedule[`${checkDay}-${t}`] === 'FREE') {
                            count++;
                            grid.innerHTML += `
                                <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:border-indigo-200 transition-colors">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-xs font-bold text-slate-800">${meta.name}</span>
                                        <span class="text-[9px] px-2 py-0.5 rounded-full font-black bg-green-100 text-green-700">FREE</span>
                                    </div>
                                    <div class="text-[10px] text-slate-400 mb-3">${meta.subjects.join(' & ')}</div>
                                    <div class="flex justify-between items-center text-[11px] font-bold border-t pt-2">
                                        <span class="text-indigo-600">${checkDay}</span>
                                        <span>${t}</span>
                                    </div>
                                </div>`;
                        }
                    });
                }
            });

            if (count === 0) grid.innerHTML = `<div class="col-span-full py-10 text-center text-slate-300 text-sm">No availability found for ${checkDateVal}. Try changing the date or filters.</div>`;
        };

        window.setActiveTeacher = (name) => {
            activeTeacherName = name;
            renderSidebar();
            fetchRangeData();
        };

        function renderSidebar() {
            const container = document.getElementById('teacherSidebar');
            container.innerHTML = teacherMetadata.map(t => `
                <button onclick="setActiveTeacher('${t.name}')" class="w-full text-left px-4 py-2 rounded-xl text-[11px] font-bold border mb-1 transition-all ${t.name === activeTeacherName ? 'sidebar-active' : 'bg-white text-slate-600 border-slate-100'}">
                    ${t.name}
                </button>
            `).join('');
        }

        document.getElementById('viewBtn').onclick = () => {
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('editorSection').classList.add('hidden');
            document.getElementById('viewBtn').className = "px-6 py-2 text-sm font-bold rounded-lg bg-indigo-600 text-white shadow-md";
            document.getElementById('editBtn').className = "px-6 py-2 text-sm font-bold rounded-lg text-slate-500";
        };
        document.getElementById('editBtn').onclick = () => {
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('editorSection').classList.remove('hidden');
            document.getElementById('editBtn').className = "px-6 py-2 text-sm font-bold rounded-lg bg-indigo-600 text-white shadow-md";
            document.getElementById('viewBtn').className = "px-6 py-2 text-sm font-bold rounded-lg text-slate-500";
        };

        init();
    </script>
</body>
</html>
