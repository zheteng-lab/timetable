<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Manager - Live Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .slot-cell { transition: all 0.1s; cursor: pointer; border: 1px solid #f1f5f9; font-size: 10px; font-weight: bold; text-align: center; height: 40px; min-width: 80px; }
        .slot-free { background-color: #f0fdf4; border-color: #bbf7d0; color: #166534; }
        .slot-booked { background-color: #fef2f2; border-color: #fecaca; color: #991b1b; }
        .slot-off { background-color: #f8fafc; border-color: #e2e8f0; color: #94a3b8; }
        .sidebar-active { background-color: #4f46e5; color: white; border-color: #4338ca; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <!-- CLEAN LOADING OVERLAY -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center transition-opacity duration-500">
        <div class="text-center p-6">
            <div id="loadingSpinner" class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <h2 class="text-base font-bold text-slate-800 mb-1">Synchronizing Data</h2>
            <p class="text-slate-400 text-xs">Accessing live center schedules...</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 lg:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Center <span class="text-indigo-600">Master List</span></h1>
                <p class="text-xs text-slate-400 font-medium uppercase tracking-widest">Live Cloud Database</p>
            </div>
            <div class="flex bg-white p-1 rounded-xl shadow-sm border border-slate-200">
                <button id="viewBtn" class="px-6 py-2 text-sm font-bold rounded-lg bg-indigo-600 text-white shadow-md transition-all">Sales Dashboard</button>
                <button id="editBtn" class="px-6 py-2 text-sm font-bold rounded-lg text-slate-500 hover:bg-slate-50 transition-colors">Teacher Editor</button>
            </div>
        </header>

        <!-- DASHBOARD SECTION -->
        <div id="dashboardSection" class="space-y-4">
            <div class="bg-white p-4 rounded-2xl border border-slate-200 grid grid-cols-1 md:grid-cols-3 gap-4 shadow-sm">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Filter Subject</label>
                    <select id="filterSubject" class="w-full bg-slate-50 p-2.5 rounded-xl border-none text-sm outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500" onchange="renderDashboard()">
                        <option value="All">All Subjects</option>
                        <option>BC</option><option>BM</option><option>BI</option><option>PK</option><option>SOK</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Filter Day</label>
                    <select id="filterDay" class="w-full bg-slate-50 p-2.5 rounded-xl border-none text-sm outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500" onchange="renderDashboard()">
                        <option value="All">All Days</option>
                        <option>Mon</option><option>Tue</option><option>Wed</option><option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
                    </select>
                </div>
                <div class="flex flex-col items-end justify-center">
                    <div id="liveStatus" class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-100 text-[10px] font-black text-emerald-600 flex items-center gap-2">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> SYSTEM ONLINE
                    </div>
                </div>
            </div>
            <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3"></div>
        </div>

        <!-- EDITOR SECTION -->
        <div id="editorSection" class="hidden flex flex-col md:flex-row gap-6">
            <div class="w-full md:w-72 space-y-1 max-h-[75vh] overflow-y-auto pr-2" id="teacherSidebar"></div>
            <div class="flex-1 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h2 id="currentTeacherTitle" class="font-bold text-lg text-slate-800 uppercase tracking-tight">Select Teacher</h2>
                        <div id="teacherDetailsDisplay" class="text-[10px] font-bold text-indigo-600 uppercase"></div>
                    </div>
                    <div id="syncIndicator" class="text-[10px] font-bold text-slate-400 px-3 py-1 rounded-full bg-white border border-slate-100 shadow-sm">Cloud Ready</div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead class="bg-slate-50/80">
                            <tr id="tableHeader"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATmsswJCUH2kzgyqhtgSHfwAfJLWhMBK0",
            authDomain: "class-one-students-enquiry.firebaseapp.com",
            projectId: "class-one-students-enquiry",
            storageBucket: "class-one-students-enquiry.firebasestorage.app",
            messagingSenderId: "808629452867",
            appId: "1:808629452867:web:fc65ad3a56b08b258fd4f6"
        };

        const appId = "timetable-manager-pro-v3";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const teacherMetadata = [
            { name: "Peggy Lok", subjects: ["BC"], assessment: true },
            { name: "Chei Leng", subjects: ["BC"], assessment: false },
            { name: "Adelynshia", subjects: ["BM", "PK"], assessment: true },
            { name: "Aubrey", subjects: ["SOK"], assessment: false },
            { name: "Avy Lau Hui Chwin", subjects: ["BM", "PK"], assessment: false },
            { name: "Nur Zahraa Balqis", subjects: ["BM", "PK"], assessment: false },
            { name: "Catherine Mu", subjects: ["BC"], assessment: false },
            { name: "Cher Xi", subjects: ["BC"], assessment: false },
            { name: "Ho Ling Yi", subjects: ["PK"], assessment: false },
            { name: "Ho Yu Xun", subjects: ["BC"], assessment: false },
            { name: "Hoh Kar Yee", subjects: ["BM"], assessment: false },
            { name: "Jenna Choong Lee Hung", subjects: ["BC", "BM"], assessment: false },
            { name: "Joy Chai Yi Ling", subjects: ["BC"], assessment: false },
            { name: "Karen Lee Wai Leng", subjects: ["BC"], assessment: true },
            { name: "Kelly Chong Kah Yee", subjects: ["BM", "PK"], assessment: false },
            { name: "Lee Shok Yuong", subjects: ["BC"], assessment: false },
            { name: "Lee Pek Kian", subjects: ["BI"], assessment: false },
            { name: "Lim Mei King", subjects: ["BI"], assessment: false },
            { name: "Lim Tze Wei (Candy)", subjects: ["BC"], assessment: false },
            { name: "Loo Eling", subjects: ["BC"], assessment: false },
            { name: "Manjusri Sivakumar", subjects: ["BI", "SOK"], assessment: false },
            { name: "Ooi Ming Yi", subjects: ["BI", "SOK"], assessment: false },
            { name: "Sam", subjects: ["SOK"], assessment: false },
            { name: "Sherrenii", subjects: ["BI", "SOK"], assessment: false },
            { name: "Shirley Lim Shay Li", subjects: ["BC", "BI"], assessment: true },
            { name: "Su Poh Yi", subjects: ["BC"], assessment: false },
            { name: "Susan Siew", subjects: ["BC", "BM", "PK"], assessment: false },
            { name: "Tan Jing En", subjects: ["BM"], assessment: false },
            { name: "Tan Jing Ru", subjects: ["BM"], assessment: false },
            { name: "Tan Tze Ting", subjects: ["BM", "PK"], assessment: true },
            { name: "Teh Dick Way", subjects: ["SOK"], assessment: false },
            { name: "Wendy Chee", subjects: ["BC"], assessment: false },
            { name: "Wong Kai Ling", subjects: ["BC"], assessment: true }
        ];
        
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const times = [];
        for (let h = 9; h <= 21; h++) {
            const p = h >= 12 ? 'PM' : 'AM';
            const hr = h > 12 ? h - 12 : h;
            times.push(`${hr}:00 ${p}`, `${hr}:30 ${p}`);
        }

        let teachersData = {};
        let activeTeacherName = teacherMetadata[0].name;

        async function init() {
            try {
                await signInAnonymously(auth);
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
                onSnapshot(colRef, (snap) => {
                    snap.forEach(doc => {
                        teachersData[doc.id] = doc.data();
                    });
                    
                    teacherMetadata.forEach(t => {
                        if (!teachersData[t.name]) {
                            teachersData[t.name] = { schedule: {} };
                        }
                    });

                    document.getElementById('loading').style.opacity = '0';
                    setTimeout(() => document.getElementById('loading').classList.add('hidden'), 500);
                    renderSidebar();
                    renderDashboard();
                    if(!document.getElementById('editorSection').classList.contains('hidden')) renderEditor();
                });
            } catch (err) {
                console.error(err);
            }
        }

        function renderSidebar() {
            const container = document.getElementById('teacherSidebar');
            container.innerHTML = teacherMetadata.map(t => `
                <button onclick="window.setActiveTeacher('${t.name}')" class="w-full text-left px-4 py-2.5 rounded-xl text-[11px] font-bold border transition-all ${t.name === activeTeacherName ? 'sidebar-active' : 'bg-white text-slate-600 border-slate-100 hover:bg-slate-50'}">
                    <div class="flex justify-between items-center">
                        <span>${t.name}</span>
                        <span class="text-[8px] opacity-60">${t.subjects.join('/')}</span>
                    </div>
                </button>
            `).join('');
        }

        window.setActiveTeacher = (name) => {
            activeTeacherName = name;
            renderSidebar();
            renderEditor();
        };

        async function saveTeacher(name) {
            const indicator = document.getElementById('syncIndicator');
            indicator.innerText = "Syncing...";
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', name);
                await setDoc(docRef, teachersData[name]);
                indicator.innerText = "Cloud Updated";
                renderDashboard();
            } catch (e) {
                indicator.innerText = "Sync Error";
            }
        }

        window.toggleSlot = (day, time) => {
            const key = `${day}-${time}`;
            const states = ['OFF', 'FREE', 'BOOKED'];
            const current = (teachersData[activeTeacherName] && teachersData[activeTeacherName].schedule[key]) || 'OFF';
            const next = states[(states.indexOf(current) + 1) % states.length];
            
            if(!teachersData[activeTeacherName].schedule) teachersData[activeTeacherName].schedule = {};
            teachersData[activeTeacherName].schedule[key] = next;
            
            const el = document.getElementById(`cell-${key}`);
            if(el) {
                el.className = `slot-cell slot-${next.toLowerCase()}`;
                el.innerText = next;
            }
            saveTeacher(activeTeacherName);
        };

        function renderEditor() {
            const meta = teacherMetadata.find(t => t.name === activeTeacherName);
            document.getElementById('currentTeacherTitle').innerText = activeTeacherName;
            document.getElementById('teacherDetailsDisplay').innerText = 
                `${meta.subjects.join(' & ')} ${meta.assessment ? 'â€¢ EXAM & ASSESSMENT' : ''}`;

            const head = document.getElementById('tableHeader');
            head.innerHTML = '<th class="p-2 text-[10px] text-slate-400 border-b border-slate-100">Time</th>' + 
                days.map(d => `<th class="p-2 text-[10px] text-slate-400 border-b border-slate-100">${d}</th>`).join('');
            
            const body = document.getElementById('tableBody');
            body.innerHTML = times.map(t => `
                <tr class="hover:bg-slate-50/50">
                    <td class="p-2 text-[9px] font-bold text-slate-400 bg-slate-50/30 border-b border-white">${t}</td>
                    ${days.map(d => {
                        const status = (teachersData[activeTeacherName] && teachersData[activeTeacherName].schedule[`${d}-${t}`]) || 'OFF';
                        return `<td id="cell-${d}-${t}" onclick="toggleSlot('${d}', '${t}')" class="slot-cell slot-${status.toLowerCase()}">${status}</td>`;
                    }).join('')}
                </tr>
            `).join('');
        }

        window.renderDashboard = () => {
            const subFilter = document.getElementById('filterSubject').value;
            const dayFilter = document.getElementById('filterDay').value;
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';
            let found = 0;

            teacherMetadata.forEach(meta => {
                const data = teachersData[meta.name];
                if (!data || !data.schedule) return;
                
                // Filter by Subject
                if (subFilter !== 'All' && !meta.subjects.includes(subFilter)) return;

                days.forEach(d => {
                    if (dayFilter !== 'All' && d !== dayFilter) return;
                    times.forEach(t => {
                        const status = data.schedule[`${d}-${t}`];
                        if (status === 'FREE') {
                            found++;
                            grid.innerHTML += `
                                <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:border-indigo-300 transition-all hover:shadow-md group">
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="flex flex-col">
                                            <span class="text-xs font-bold text-slate-800 truncate pr-2 group-hover:text-indigo-600 transition-colors">${meta.name}</span>
                                            ${meta.assessment ? '<span class="text-[8px] text-indigo-500 font-bold">EXAM / ASSESS READY</span>' : ''}
                                        </div>
                                        <span class="text-[9px] px-2 py-0.5 rounded-full font-black tracking-tight bg-green-100 text-green-700">FREE</span>
                                    </div>
                                    <div class="text-[10px] text-slate-400 mb-3 font-medium">${meta.subjects.join(' & ')}</div>
                                    <div class="flex justify-between items-center text-[11px] font-bold text-slate-800 border-t border-slate-50 pt-3">
                                        <span class="text-indigo-600">${d}</span>
                                        <span class="bg-slate-50 px-2 py-0.5 rounded border border-slate-100">${t}</span>
                                    </div>
                                </div>
                            `;
                        }
                    });
                });
            });
            if (found === 0) grid.innerHTML = '<div class="col-span-full py-20 text-center text-slate-300 text-sm italic font-medium">No matches found for your current filters.</div>';
        };

        document.getElementById('viewBtn').onclick = () => {
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('editorSection').classList.add('hidden');
            document.getElementById('viewBtn').className = "px-6 py-2 text-sm font-bold rounded-lg bg-indigo-600 text-white shadow-md";
            document.getElementById('editBtn').className = "px-6 py-2 text-sm font-bold rounded-lg text-slate-500 hover:bg-slate-100";
            renderDashboard();
        };
        document.getElementById('editBtn').onclick = () => {
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('editorSection').classList.remove('hidden');
            document.getElementById('editBtn').className = "px-6 py-2 text-sm font-bold rounded-lg bg-indigo-600 text-white shadow-md";
            document.getElementById('viewBtn').className = "px-6 py-2 text-sm font-bold rounded-lg text-slate-500 hover:bg-slate-100";
            renderEditor();
        };

        init();
    </script>
</body>
</html>
