<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Manager - Date Range Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .slot-cell { transition: all 0.1s; cursor: pointer; border: 1px solid #f1f5f9; font-size: 10px; font-weight: bold; text-align: center; height: 40px; min-width: 80px; }
        .slot-free { background-color: #f0fdf4; border-color: #bbf7d0; color: #166534; }
        .slot-booked { background-color: #fef2f2; border-color: #fecaca; color: #991b1b; }
        .slot-off { background-color: #f8fafc; border-color: #e2e8f0; color: #94a3b8; }
        .sidebar-active { background-color: #4f46e5; color: white; border-color: #4338ca; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <!-- LOADING OVERLAY -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center transition-opacity duration-500">
        <div class="text-center p-6">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <h2 class="text-base font-bold text-slate-800 mb-1">Accessing Master Database</h2>
            <p class="text-slate-400 text-xs">Loading live schedules...</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 lg:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Class One <span class="text-indigo-600">Master List</span></h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Master List System</p>
            </div>
            <div class="flex bg-white p-1 rounded-xl shadow-sm border border-slate-200">
                <button id="viewBtn" class="px-6 py-2 text-sm font-bold rounded-lg bg-indigo-600 text-white shadow-md transition-all">Sales View</button>
                <button id="editBtn" class="px-6 py-2 text-sm font-bold rounded-lg text-slate-500 hover:bg-slate-50 transition-colors">Timeslot Update</button>
            </div>
        </header>

        <!-- DASHBOARD SECTION (Sales) -->
        <div id="dashboardSection" class="space-y-4">
            <div class="bg-white p-5 rounded-2xl border border-slate-200 grid grid-cols-1 md:grid-cols-4 gap-4 shadow-sm">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Check Availability For</label>
                    <input type="date" id="dashDate" class="w-full bg-slate-50 p-2.5 rounded-xl border-none text-sm outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500" onchange="renderDashboard()">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Filter Subject</label>
                    <select id="filterSubject" class="w-full bg-slate-50 p-2.5 rounded-xl border-none text-sm outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500" onchange="renderDashboard()">
                        <option value="All">All Subjects</option>
                        <option>BC</option><option>BM</option><option>BI</option><option>PK</option><option>SOK</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Filter Day</label>
                    <select id="filterDay" class="w-full bg-slate-50 p-2.5 rounded-xl border-none text-sm outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500" onchange="renderDashboard()">
                        <option value="All">All Days</option>
                        <option>Mon</option><option>Tue</option><option>Wed</option><option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
                    </select>
                </div>
                <div class="flex flex-col items-end justify-center">
                    <div id="sheetStatus" class="px-3 py-1 rounded-full bg-slate-50 border border-slate-100 text-[9px] font-black text-slate-400 flex items-center gap-2">
                         Connecting to Sheets...
                    </div>
                </div>
            </div>
            <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3"></div>
        </div>

        <!-- EDITOR SECTION (Admin) -->
        <div id="editorSection" class="hidden flex flex-col md:flex-row gap-6">
            <div class="w-full md:w-72 space-y-1 max-h-[75vh] overflow-y-auto pr-2 scrollbar-hide" id="teacherSidebar"></div>
            
            <div class="flex-1 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex flex-col sm:flex-row justify-between gap-4">
                    <div>
                        <h2 id="currentTeacherTitle" class="font-bold text-lg text-slate-800 uppercase">Select Teacher</h2>
                        <div id="teacherDetailsDisplay" class="text-[10px] font-bold text-indigo-600 uppercase"></div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-4 bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex flex-col">
                            <label class="text-[9px] font-bold text-slate-400 uppercase mb-1">Start Date</label>
                            <input type="date" id="startDate" class="text-xs p-1.5 rounded border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" onchange="fetchRangeData()">
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[9px] font-bold text-slate-400 uppercase mb-1">End Date</label>
                            <input type="date" id="endDate" class="text-xs p-1.5 rounded border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" onchange="fetchRangeData()">
                        </div>
                        <div class="flex items-center self-end">
                            <div id="syncIndicator" class="text-[9px] font-black text-slate-400 px-3 py-2 rounded-lg bg-slate-50 border border-slate-100 uppercase">Syncing...</div>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead class="bg-slate-50/80">
                            <tr id="tableHeader"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const GOOGLE_SHEET_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz7VEwAn6bxLkcrHi0sOtOcZjl-q5VnLc1SaVKvAShRVte8ehlbOqCHoIhOLiE36jZn/exec";

        const firebaseConfig = {
            apiKey: "AIzaSyATmsswJCUH2kzgyqhtgSHfwAfJLWhMBK0",
            authDomain: "class-one-students-enquiry.firebaseapp.com",
            projectId: "class-one-students-enquiry",
            storageBucket: "class-one-students-enquiry.firebasestorage.app",
            messagingSenderId: "808629452867",
            appId: "1:808629452867:web:fc65ad3a56b08b258fd4f6"
        };

        const appId = "timetable-manager-v4-range";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const teacherMetadata = [
            { name: "Peggy Lok", subjects: ["BC"], assessment: true },
            { name: "Chei Leng", subjects: ["BC"], assessment: false },
            { name: "Adelynshia", subjects: ["BM", "PK"], assessment: true },
            { name: "Aubrey", subjects: ["SOK"], assessment: false },
            { name: "Avy Lau Hui Chwin", subjects: ["BM", "PK"], assessment: false },
            { name: "Nur Zahraa Balqis", subjects: ["BM", "PK"], assessment: false },
            { name: "Catherine Mu", subjects: ["BC"], assessment: false },
            { name: "Cher Xi", subjects: ["BC"], assessment: false },
            { name: "Ho Ling Yi", subjects: ["PK"], assessment: false },
            { name: "Ho Yu Xun", subjects: ["BC"], assessment: false },
            { name: "Hoh Kar Yee", subjects: ["BM"], assessment: false },
            { name: "Jenna Choong Lee Hung", subjects: ["BC", "BM"], assessment: false },
            { name: "Joy Chai Yi Ling", subjects: ["BC"], assessment: false },
            { name: "Karen Lee Wai Leng", subjects: ["BC"], assessment: true },
            { name: "Kelly Chong Kah Yee", subjects: ["BM", "PK"], assessment: false },
            { name: "Lee Shok Yuong", subjects: ["BC"], assessment: false },
            { name: "Lee Pek Kian", subjects: ["BI"], assessment: false },
            { name: "Lim Mei King", subjects: ["BI"], assessment: false },
            { name: "Lim Tze Wei (Candy)", subjects: ["BC"], assessment: false },
            { name: "Loo Eling", subjects: ["BC"], assessment: false },
            { name: "Manjusri Sivakumar", subjects: ["BI", "SOK"], assessment: false },
            { name: "Ooi Ming Yi", subjects: ["BI", "SOK"], assessment: false },
            { name: "Sam", subjects: ["SOK"], assessment: false },
            { name: "Sherrenii", subjects: ["BI", "SOK"], assessment: false },
            { name: "Shirley Lim Shay Li", subjects: ["BC", "BI"], assessment: true },
            { name: "Su Poh Yi", subjects: ["BC"], assessment: false },
            { name: "Susan Siew", subjects: ["BC", "BM", "PK"], assessment: false },
            { name: "Tan Jing En", subjects: ["BM"], assessment: false },
            { name: "Tan Jing Ru", subjects: ["BM"], assessment: false },
            { name: "Tan Tze Ting", subjects: ["BM", "PK"], assessment: true },
            { name: "Teh Dick Way", subjects: ["SOK"], assessment: false },
            { name: "Wendy Chee", subjects: ["BC"], assessment: false },
            { name: "Wong Kai Ling", subjects: ["BC"], assessment: true }
        ];
        
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const times = [];
        for (let h = 8; h <= 21; h++) {
            const p = h >= 12 ? 'PM' : 'AM';
            const hr = h > 12 ? h - 12 : h;
            times.push(`${hr}:00 ${p}`, `${hr}:30 ${p}`);
        }

        // State
        let allSchedules = []; // Array of {teacher, start, end, schedule}
        let currentRangeData = { schedule: {} };
        let activeTeacherName = teacherMetadata[0].name;

        // Init dates
        const now = new Date();
        const firstDay = new Date(now.setDate(now.getDate() - now.getDay() + 1)).toISOString().split('T')[0];
        const lastDay = new Date(now.setDate(now.getDate() - now.getDay() + 7)).toISOString().split('T')[0];
        
        document.getElementById('startDate').value = firstDay;
        document.getElementById('endDate').value = lastDay;
        document.getElementById('dashDate').value = new Date().toISOString().split('T')[0];

        async function init() {
            try {
                await signInAnonymously(auth);
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'ranges');
                
                onSnapshot(colRef, (snap) => {
                    allSchedules = [];
                    snap.forEach(doc => {
                        allSchedules.push({ id: doc.id, ...doc.data() });
                    });
                    document.getElementById('loading').classList.add('hidden');
                    renderSidebar();
                    renderDashboard();
                });

                fetchRangeData();
                syncFromGoogleSheets();
            } catch (err) { console.error(err); }
        }

        async function syncFromGoogleSheets() {
            const el = document.getElementById('sheetStatus');
            try {
                const res = await fetch(GOOGLE_SHEET_WEB_APP_URL);
                const data = await res.json();
                el.innerText = "SHEETS SYNCED";
                el.className = "px-3 py-1 rounded-full bg-indigo-50 border border-indigo-100 text-[9px] font-black text-indigo-600 flex items-center gap-2";
                
                // Process sheet data as default overrides if needed
                // For this implementation, we treat Firebase as source of truth for Ranges.
            } catch (e) {
                el.innerText = "SHEET OFFLINE";
            }
        }

        async function fetchRangeData() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const docId = `${activeTeacherName}_${start}_${end}`.replace(/\//g, '-');
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'ranges', docId);
            
            const indicator = document.getElementById('syncIndicator');
            indicator.innerText = "LOADING...";
            
            try {
                const res = await getDoc(docRef);
                currentRangeData = res.exists() ? res.data() : { 
                    teacher: activeTeacherName, 
                    start, 
                    end, 
                    schedule: {} 
                };
                indicator.innerText = "CLOUD SYNCED";
                renderEditor();
            } catch (e) {
                indicator.innerText = "ERROR";
            }
        }

        window.toggleSlot = async (day, time) => {
            const key = `${day}-${time}`;
            const states = ['OFF', 'FREE', 'BOOKED'];
            const current = currentRangeData.schedule[key] || 'OFF';
            const next = states[(states.indexOf(current) + 1) % states.length];
            
            currentRangeData.schedule[key] = next;
            const el = document.getElementById(`cell-${key}`);
            if(el) {
                el.className = `slot-cell slot-${next.toLowerCase()}`;
                el.innerText = next;
            }

            // Auto-save range
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const docId = `${activeTeacherName}_${start}_${end}`.replace(/\//g, '-');
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'ranges', docId);
            
            document.getElementById('syncIndicator').innerText = "SAVING...";
            await setDoc(docRef, currentRangeData);
            document.getElementById('syncIndicator').innerText = "SAVED";
        };

        function renderEditor() {
            const meta = teacherMetadata.find(t => t.name === activeTeacherName);
            document.getElementById('currentTeacherTitle').innerText = activeTeacherName;
            document.getElementById('teacherDetailsDisplay').innerText = 
                `${meta.subjects.join(' & ')} ${meta.assessment ? 'â€¢ ASSESSMENT INCLUDED' : ''}`;

            const head = document.getElementById('tableHeader');
            head.innerHTML = '<th class="p-2 text-[10px] text-slate-400 border-b border-slate-100">Time</th>' + 
                days.map(d => `<th class="p-2 text-[10px] text-slate-400 border-b border-slate-100">${d}</th>`).join('');
            
            const body = document.getElementById('tableBody');
            body.innerHTML = times.map(t => `
                <tr class="hover:bg-slate-50/50">
                    <td class="p-2 text-[9px] font-bold text-slate-400 bg-slate-50/30 border-b border-white">${t}</td>
                    ${days.map(d => {
                        const status = currentRangeData.schedule[`${d}-${t}`] || 'OFF';
                        return `<td id="cell-${d}-${t}" onclick="toggleSlot('${d}', '${t}')" class="slot-cell slot-${status.toLowerCase()}">${status}</td>`;
                    }).join('')}
                </tr>
            `).join('');
        }

        window.renderDashboard = () => {
            const checkDate = new Date(document.getElementById('dashDate').value);
            const checkDay = days[(checkDate.getDay() + 6) % 7]; // Adjust 0=Sun to Mon-Sun array
            
            const subFilter = document.getElementById('filterSubject').value;
            const dayFilter = document.getElementById('filterDay').value;
            
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';
            let count = 0;

            // Find valid ranges for this date
            allSchedules.forEach(record => {
                const start = new Date(record.start);
                const end = new Date(record.end);
                
                // Is this date within the range?
                if (checkDate >= start && checkDate <= end) {
                    const meta = teacherMetadata.find(t => t.name === record.teacher);
                    if (!meta) return;

                    const subjectMatch = subFilter === 'All' || meta.subjects.includes(subFilter);
                    if (!subjectMatch) return;

                    // Check day matches
                    if (dayFilter !== 'All' && checkDay !== dayFilter) return;

                    times.forEach(t => {
                        const status = record.schedule[`${checkDay}-${t}`];
                        if (status === 'FREE') {
                            count++;
                            grid.innerHTML += `
                                <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:border-indigo-300 transition-all hover:shadow-md group">
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="flex flex-col">
                                            <span class="text-xs font-bold text-slate-800 truncate pr-2 group-hover:text-indigo-600 transition-colors">${meta.name}</span>
                                            ${meta.assessment ? '<span class="text-[8px] text-indigo-500 font-bold uppercase">Assessment</span>' : ''}
                                        </div>
                                        <span class="text-[9px] px-2 py-0.5 rounded-full font-black tracking-tight bg-green-100 text-green-700">FREE</span>
                                    </div>
                                    <div class="text-[10px] text-slate-400 mb-3 font-medium">${meta.subjects.join(' & ')}</div>
                                    <div class="flex justify-between items-center text-[11px] font-bold text-slate-800 border-t border-slate-50 pt-3">
                                        <span class="text-indigo-600">${checkDay}</span>
                                        <span class="bg-slate-50 px-2 py-0.5 rounded border border-slate-100">${t}</span>
                                    </div>
                                </div>
                            `;
                        }
                    });
                }
            });

            if (count === 0) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center text-slate-300 text-sm italic">No availability found for this selection.</div>`;
            }
        };

        window.setActiveTeacher = (name) => {
            activeTeacherName = name;
            renderSidebar();
            fetchRangeData();
        };

        function renderSidebar() {
            const container = document.getElementById('teacherSidebar');
            container.innerHTML = teacherMetadata.map(t => `
                <button onclick="setActiveTeacher('${t.name}')" class="w-full text-left px-4 py-2.5 rounded-xl text-[11px] font-bold border transition-all ${t.name === activeTeacherName ? 'sidebar-active' : 'bg-white text-slate-600 border-slate-100 hover:bg-slate-50'}">
                    <div class="flex justify-between items-center">
                        <span>${t.name}</span>
                        <span class="text-[8px] opacity-60">${t.subjects.join('/')}</span>
                    </div>
                </button>
            `).join('');
        }

        document.getElementById('viewBtn').onclick = () => {
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('editorSection').classList.add('hidden');
            document.getElementById('viewBtn').className = "px-6 py-2 text-sm font-bold rounded-lg bg-indigo-600 text-white shadow-md";
            document.getElementById('editBtn').className = "px-6 py-2 text-sm font-bold rounded-lg text-slate-500 hover:bg-slate-50";
        };
        document.getElementById('editBtn').onclick = () => {
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('editorSection').classList.remove('hidden');
            document.getElementById('editBtn').className = "px-6 py-2 text-sm font-bold rounded-lg bg-indigo-600 text-white shadow-md";
            document.getElementById('viewBtn').className = "px-6 py-2 text-sm font-bold rounded-lg text-slate-500 hover:bg-slate-50";
        };

        init();
    </script>
</body>
</html>
